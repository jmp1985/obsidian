Obsidian tutorial
*****************

1. Overview
===========

Obsidian is a package for preprocessing and classifying powder diffraction images as containing protein rings or not. If raw data is in cbf format, it first needs to be converted to npy format in dials.python before running the rest of obsidian in python3

2. Data conversion and storage
==============================

2.1 Converting and storing cbf data files
-----------------------------------------

Obsidian has a function :mod:`obsidian.utils.cbf_to_npy` which will convert files to npy format and crop them down to a relevant resolution if the
following are specified:
* beam centre: This must be provided in the order (y, x) or (pixel_row, pixel_column)
* max resolution: maximum resuoltion in Angstroms (reccommended: 7)

If this info is not provided, bad things will happen...

The following arguments are required:
* root directory: folder containing grid scans to be analysed
* destination directory: folder in which to store converted data and background files (will be created if not pre-existing)

.. warning::

   Make sure destination directory has plenty of disk space (around 30MB per tray)

.. code-block:: console

  module.load dials
  dials.python obsidian/cbf_to_npy --root </path/to/data/tray2> --dest <big/disk> -b </path/to/background/data/tray2/g1> -r 7 -c "(1321.16, 1249.94)"

for images cropped to 7 Angstrom, with beam centre beam_y = 1321.16, beam_x = 1249.94. Note the quotation marks around beam centre tuple.

You should now have a folder in big/disk corresponding to the root cbf directory including all subfolders and a background file.

**All remaining modules are to be run in python 3**

3. Finding protein rings
========================

Once .npy files have been created, preprocessing, feature extraction and classification can be performed with use of the :mod:`obsidian.find_rings` module.


If the images have been pre-cropped:

.. code-block:: console

   obsidian.find_rings
   Enter data directory: big/disk/trayX

The top results for each directory will be displayed after classification



